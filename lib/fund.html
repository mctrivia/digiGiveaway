<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
		<script src="min.js"></script>
		<script>
$(function() {
	var fee=10000;




	//generate pay request window
	$(document).on("click","#genQR",function() {
		//load input and validate it is json
		var data=JSON.parse($("#data").val());
		
		//calculate amount needed
		var dgbS=fee*data.length+100000;
		for (var wallet of data) {
			dgbS+=wallet["value"];
		}
		var dgb=(dgbS/100000000).toFixed(8);				//string containing amount in DigiByte
		$("#value").html(dgb);
	
		//generate temp wallet
		var digibyte=require('digibyte');
		var privateKey=new digibyte.PrivateKey();
		var tempWallet=privateKey.toAddress();
		tempWalletAddress=tempWallet.toString();
		var qrcode=new QRCode(document.getElementById("qr"),{
			text:	'digibyte:'+tempWalletAddress+'?amount='+dgb,
			width:	200,
			height:	200,
			colorDark:	"#000000",
			colorLight:	"#ffffff",
			correctLevel:	QRCode.CorrectLevel.L
		});
		
		//show pay window
		$("#pay").show();
	
		//watch temp wallet for payment
		var keepChecking=setInterval(function() {
			$.getJSON("https://digiexplorer.info/api/addr/"+tempWalletAddress,function(checkData) {
				var balance=checkData["balanceSat"];
				
				if (balance>=dgbS) {									
					//delete interval
					clearInterval(keepChecking);			
					
					//get utxos
					$.getJSON("https://digiexplorer.info/api/addr/"+tempWalletAddress+"/utxo",function(utxos) {
			
						//initialize transaction
						var transaction=new digibyte.Transaction()
							.from(utxos)
							.change(digibyte.Address.fromString('DMw9wz6KHsvbvXsmo1Q8BajWcohYwjqwoq'));	//dust wallet.  goes towards maintenance costs
						
						//set all that need to get payed
var change=balance;
						for (var wallet of data) {
							transaction.to(digibyte.Address.fromString(wallet["pub"]),wallet["value"]);
							console.log(digibyte.Address.fromString(wallet["pub"]),wallet["value"]);
change-=wallet["value"];
						}
						
						//set max transaction cost.  If api calculates lower then remainder goes to dust wallet to help with server costs
						if (transaction.getFee()>data.length*fee) {
							transaction.fee(Math.floor(data.length*fee));
						}
change-=transaction.getFee();
						console.log(transaction.getFee());
						console.log("change:",change);
						
						//sign transaction
						transaction.sign(privateKey);
						console.log(transaction.serialize());
						
						//make transaction
						$.ajax({
							"type":			"POST",
							"url":			"https://digiexplorer.info/api/tx/send",
							"crossDomain":	true,
							"contentType":	"application/json",
							"data":			JSON.stringify({
								"rawtx":	transaction.serialize(),									
							}),
							"success":		function() {
								//show thank you page
								$("#pay").hide();
								$("#good").show();
							},
							"error":		function(jqXHR,textStatus,errorThrown) {
								var wif=privateKey.toWIF();
							
								//error handling.  Need to make better but works for now
								console.log(jqXHR,textStatus,errorThrown);
								console.log("something want wrong private key to recover funds is: " + wif);
								
								
								$("#failqr").html('');
								var qrcode=new QRCode(document.getElementById("failqr"),{
									text:	wif,
									width:	200,
									height:	200,
									colorDark:	"#000000",
									colorLight:	"#ffffff",
									correctLevel:	QRCode.CorrectLevel.L
								});
								$(".shadow").show();
								
							},
						});
					});							
					
					
				}
				
			});	
			
		},15000);
	
	
	
	});


});		
		</script>
		<style>
			#pay{
				display:none;
			}
			
			#data{
				width:		500px;
				height:		400px;
			}
			#good{
				display: none;
			}
			
			
			.shadow{
				position:	fixed;
				display:	none;
			}
			#shadow {
				z-index:			1000;
				background-color:	RGBA(0,0,0,0.3);
				left:		0px;
				top:		0px;
				width:		100%;
				height:		100%;
			}
			#error{
				z-index:	1001;
				background-color:	RGBA(255,255,255,1);
				left:		50%;
				top:		50%;
				width:		400px;
				margin-left:-200px;
				height:		400px;
				margin-top:	-200px;
				text-align:	center;
			}
		</style>
	</head>
	<body>
		Past data here to fund:<br>
		<textarea id="data"></textarea>
		<input type="button" id="genQR" value="Generate Payment Request">
		<div id="pay">
			<hr>
			<h1>Please send <span id="value"></span>DGB to here:</h1>
			<div id="qr"></div>
		</div>
		<div id="good">
			<h1>All wallets funded successfully</h1>		
		</div>
		<div id="error" class="shadow"><h3>Payment transfer failed:  You can recover funds with this</h3><div id="failqr"></div></div>
		<div id="shadow" class="shadow"></div>

	</body>
</div>